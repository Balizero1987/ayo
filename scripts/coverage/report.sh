#!/bin/bash
#
# Global Coverage Report Generator
#
# Generates comprehensive coverage reports for both backend and frontend.
# Outputs a combined markdown report.
#
# Usage:
#     bash scripts/coverage/report.sh
#

set -euo pipefail

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
REPORTS_DIR="$REPO_ROOT/docs/reports"

cd "$REPO_ROOT"

# Ensure reports directory exists
mkdir -p "$REPORTS_DIR"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“Š GLOBAL COVERAGE REPORT GENERATOR"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

REPORT_FILE="$REPORTS_DIR/COVERAGE_GLOBAL_REPORT.md"
TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

# Start report
cat > "$REPORT_FILE" << EOF
# Global Coverage Report

**Generated**: ${TIMESTAMP}

This report shows global test coverage for both backend and frontend codebases.

---

## Backend Coverage

EOF

# Run backend coverage report
echo "ðŸ“Š Generating backend coverage report..."
echo ""

cd "$REPO_ROOT/apps/backend-rag"

if python3 "$REPO_ROOT/apps/backend-rag/scripts/calculate_coverage_all_types.py" >> "$REPORT_FILE" 2>&1; then
    echo -e "${GREEN}âœ… Backend coverage report generated${NC}"
else
    echo "âš ï¸  Backend coverage report had issues, but continuing..."
fi

# Extract backend summary if COVERAGE_REPORT_ALL_TYPES.md exists
if [ -f "$REPO_ROOT/apps/backend-rag/COVERAGE_REPORT_ALL_TYPES.md" ]; then
    echo "" >> "$REPORT_FILE"
    echo "### Detailed Backend Report" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "See: \`apps/backend-rag/COVERAGE_REPORT_ALL_TYPES.md\`" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
fi

cd "$REPO_ROOT"

# Add frontend section
cat >> "$REPORT_FILE" << EOF

---

## Frontend Coverage

EOF

# Run frontend coverage
echo "ðŸ“Š Generating frontend coverage report..."
echo ""

if npm run test:coverage >> "$REPORT_FILE" 2>&1; then
    echo -e "${GREEN}âœ… Frontend coverage report generated${NC}"
else
    echo "âš ï¸  Frontend coverage report had issues, but continuing..."
fi

# Try to extract Jest coverage summary
if [ -f "$REPO_ROOT/coverage/coverage-summary.json" ]; then
    echo "" >> "$REPORT_FILE"
    echo "### Frontend Coverage Summary" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
    echo "\`\`\`json" >> "$REPORT_FILE"
    cat "$REPO_ROOT/coverage/coverage-summary.json" | head -50 >> "$REPORT_FILE"
    echo "\`\`\`" >> "$REPORT_FILE"
    echo "" >> "$REPORT_FILE"
fi

# Add summary section
cat >> "$REPORT_FILE" << EOF

---

## Summary

### Coverage Targets

- **Backend Unit Tests**: Target â‰¥95%
- **Backend Integration Tests**: Target â‰¥95%
- **Backend API Tests**: Target â‰¥95%
- **Frontend**: Target â‰¥70% (soft floor)

### Recommendations

1. Focus on files with lowest coverage first
2. Use \`scripts/coverage/gate.sh\` to check diff coverage before committing
3. Run \`scripts/coverage/report.sh\` regularly to track global trends
4. Ensure new code meets diff coverage threshold (â‰¥80%)

### Next Steps

- Review files below target coverage
- Add tests for uncovered areas
- Use \`scripts/test_automation/test_generator.py\` to generate test skeletons

---

**Report generated by**: \`scripts/coverage/report.sh\`  
**See also**: \`docs/reports/COVERAGE_AUTOMATION.md\` for usage instructions

EOF

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "${GREEN}âœ… Report generated: ${REPORT_FILE}${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

